"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.createRequestOptions = void 0;
const lodash_1 = require("lodash");
const is_stream_1 = __importDefault(require("is-stream"));
const interfaces_1 = require("./interfaces");
const testcafe_hammerhead_1 = require("testcafe-hammerhead");
const content_types_1 = __importDefault(require("../../assets/content-types"));
const http_headers_1 = __importDefault(require("../../utils/http-headers"));
const types_1 = require("../../errors/types");
const runtime_1 = require("../../errors/runtime");
const actions_1 = require("../commands/actions");
const DEFAULT_ACCEPT = { [http_headers_1.default.accept]: `${content_types_1.default.json}, ${content_types_1.default.textPlain}, ${content_types_1.default.all}` };
const METHODS_WITH_CONTENT_TYPE = ['post', 'put', 'patch'];
const DEFAULT_REQUEST_METHOD = 'GET';
const DEFAULT_PROTOCOL = 'http:';
function setContentTypeIfNotExists(headers, value) {
    if (!(0, lodash_1.isUndefined)(headers) && (0, lodash_1.isUndefined)(headers[http_headers_1.default.contentType]))
        headers[http_headers_1.default.contentType] = value;
}
function typeOf(value) {
    if (value === null)
        return 'null';
    if (value && typeof value === 'object')
        return value.constructor.name.toLowerCase();
    return typeof value;
}
function transformBody(headers, body) {
    if (!body)
        return Buffer.from('');
    if (typeOf(body) === 'formdata' ||
        typeOf(body) === 'file' ||
        typeOf(body) === 'blob' ||
        (0, lodash_1.isArrayBuffer)(body) ||
        (0, lodash_1.isBuffer)(body) ||
        (0, is_stream_1.default)(body))
        return Buffer.from(body);
    else if (ArrayBuffer.isView(body))
        return Buffer.from(body.buffer);
    else if (body instanceof URLSearchParams) {
        setContentTypeIfNotExists(headers, `${content_types_1.default.urlencoded};charset=utf-8`);
        return Buffer.from(body.toString());
    }
    else if ((0, lodash_1.isObject)(body) || headers && headers[http_headers_1.default.contentType] === content_types_1.default.json) {
        setContentTypeIfNotExists(headers, content_types_1.default.json);
        return Buffer.from(JSON.stringify(body));
    }
    else if (typeof body === 'string')
        setContentTypeIfNotExists(headers, content_types_1.default.textPlain);
    return body;
}
function getAuthString(auth) {
    return 'Basic ' + Buffer.from(auth.username + ':' + auth.password, 'utf8').toString('base64');
}
function changeHeaderNamesToLowercase(headers) {
    const lowerCaseHeaders = {};
    Object.keys(headers).forEach(headerName => {
        lowerCaseHeaders[headerName.toLowerCase()] = headers[headerName];
    });
    return lowerCaseHeaders;
}
async function prepareHeaders(headers, currentPageUrl, url, body, testRun, withCredentials, options) {
    var _a;
    const { host, origin } = url;
    const preparedHeaders = Object.assign({}, DEFAULT_ACCEPT, changeHeaderNamesToLowercase(headers));
    preparedHeaders[http_headers_1.default.host] = host;
    preparedHeaders[http_headers_1.default.origin] = origin;
    preparedHeaders[http_headers_1.default.contentLength] = body.length;
    if (headers.method && METHODS_WITH_CONTENT_TYPE.includes(String(headers.method)))
        preparedHeaders[http_headers_1.default.contentType] = content_types_1.default.urlencoded;
    if (options.auth && withCredentials)
        preparedHeaders[http_headers_1.default.authorization] = getAuthString(options.auth);
    if ((_a = options.proxy) === null || _a === void 0 ? void 0 : _a.auth)
        preparedHeaders[http_headers_1.default.proxyAuthorization] = getAuthString(options.proxy.auth);
    if (withCredentials) {
        const currentPageCookies = await testRun.cookieProvider.getCookieHeader(currentPageUrl.href, currentPageUrl.hostname);
        if (currentPageCookies)
            preparedHeaders[http_headers_1.default.cookie] = currentPageCookies;
    }
    //NOTE: Additional header to recognize API requests in the hammerhead
    preparedHeaders[http_headers_1.default.isApiRequest] = 'true';
    return preparedHeaders;
}
async function prepareUrl(testRun, currentPageUrl, url, callsite) {
    let preparedUrl;
    try {
        preparedUrl = url instanceof URL
            ? url
            : new URL(url, currentPageUrl.hostname ? currentPageUrl.origin : void 0);
    }
    catch (e) {
        throw new runtime_1.APIError(callsite, types_1.RUNTIME_ERRORS.requestUrlInvalidValueError, url);
    }
    return preparedUrl;
}
function prepareSearchParams(url, params) {
    if (!params)
        return url;
    let searchParams;
    if (params instanceof URLSearchParams)
        searchParams = params;
    else {
        searchParams = new URLSearchParams();
        for (const key in params) {
            if (!params[key])
                continue;
            (0, lodash_1.castArray)(params[key]).forEach(v => {
                searchParams.append(key, typeof v === 'object' ? JSON.stringify(v) : String(v));
            });
        }
    }
    return `${url}${url.includes('?') ? '&' : '?'}${searchParams.toString()}`;
}
function getProxyUrl(testRun, url, withCredentials) {
    return testRun.executeCommand(new actions_1.GetProxyUrlCommand({
        url: url,
        options: { credentials: withCredentials ? interfaces_1.Credentials.include : interfaces_1.Credentials.omit },
    }, testRun, true));
}
async function resolvePoxylessUrlParts(url) {
    const { href, hostname, port, pathname, search, protocol, } = url;
    const partAfterHost = [pathname, search].join('');
    return { partAfterHost, href, hostname, port, protocol };
}
async function resolvePoxyUrlParts(testRun, url, withCredentials) {
    const href = await getProxyUrl(testRun, url.href, withCredentials);
    const urlObj = await (0, testcafe_hammerhead_1.parseProxyUrl)(href);
    const { partAfterHost } = urlObj;
    const { hostname, port } = urlObj.proxy;
    return { partAfterHost, href, hostname, port, protocol: DEFAULT_PROTOCOL };
}
function resolveUrlParts(testRun, url, withCredentials) {
    return testRun.isProxyless() ? resolvePoxylessUrlParts(url) : resolvePoxyUrlParts(testRun, url, withCredentials);
}
async function createRequestOptions(currentPageUrl, testRun, options, callsite) {
    options.headers = options.headers || {};
    const url = await prepareUrl(testRun, currentPageUrl, options.url, callsite);
    const withCredentials = !currentPageUrl.host || (0, testcafe_hammerhead_1.sameOriginCheck)(currentPageUrl.href, url.href) || options.withCredentials || false;
    const body = transformBody(options.headers, options.body);
    const headers = await prepareHeaders(options.headers, currentPageUrl, url, body, testRun, withCredentials, options);
    let auth = options.auth;
    const { hostname, port, href, partAfterHost, protocol, } = await resolveUrlParts(testRun, url, withCredentials);
    if (!auth && url.username && url.password) {
        auth = {
            username: url.username,
            password: url.password,
        };
    }
    const requestParams = {
        method: options.method || DEFAULT_REQUEST_METHOD,
        url: href,
        protocol: protocol,
        hostname: hostname,
        host: hostname,
        port: port,
        path: prepareSearchParams(partAfterHost, options.params),
        auth: auth && withCredentials ? `${auth.username}:${auth.password}` : void 0,
        headers: headers,
        credentials: withCredentials ? testRun.session.getAuthCredentials() : void 0,
        body: body,
        disableHttp2: testRun.session.isHttp2Disabled(),
        requestTimeout: {
            ajax: options.timeout,
            page: options.timeout,
        },
    };
    if (options.proxy) {
        requestParams.externalProxySettings = {
            host: options.proxy.host,
            hostname: options.proxy.host,
            port: options.proxy.port.toString(),
            proxyAuth: options.proxy.auth ? `${options.proxy.auth.username}:${options.proxy.auth.password}` : void 0,
        };
        requestParams.protocol = url.protocol;
        requestParams.host = url.host;
        requestParams.hostname = url.hostname;
        requestParams.port = url.port;
        requestParams.path = prepareSearchParams(url.pathname + url.search, options.params);
    }
    return new testcafe_hammerhead_1.RequestOptions(requestParams);
}
exports.createRequestOptions = createRequestOptions;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JlYXRlLXJlcXVlc3Qtb3B0aW9ucy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy90ZXN0LXJ1bi9yZXF1ZXN0L2NyZWF0ZS1yZXF1ZXN0LW9wdGlvbnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQ0EsbUNBTWdCO0FBQ2hCLDBEQUFpQztBQUNqQyw2Q0FLc0I7QUFDdEIsNkRBSzZCO0FBRTdCLCtFQUF1RDtBQUN2RCw0RUFBb0Q7QUFDcEQsOENBQW9EO0FBQ3BELGtEQUFnRDtBQUNoRCxpREFBeUQ7QUFHekQsTUFBTSxjQUFjLEdBQWMsRUFBRSxDQUFDLHNCQUFZLENBQUMsTUFBTSxDQUFDLEVBQUUsR0FBRyx1QkFBYSxDQUFDLElBQUksS0FBSyx1QkFBYSxDQUFDLFNBQVMsS0FBSyx1QkFBYSxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUM7QUFDdkksTUFBTSx5QkFBeUIsR0FBRyxDQUFDLE1BQU0sRUFBRSxLQUFLLEVBQUUsT0FBTyxDQUFDLENBQUM7QUFDM0QsTUFBTSxzQkFBc0IsR0FBTSxLQUFLLENBQUM7QUFDeEMsTUFBTSxnQkFBZ0IsR0FBWSxPQUFPLENBQUM7QUFFMUMsU0FBUyx5QkFBeUIsQ0FBRSxPQUE0QixFQUFFLEtBQWE7SUFDM0UsSUFBSSxDQUFDLElBQUEsb0JBQVcsRUFBQyxPQUFPLENBQUMsSUFBSSxJQUFBLG9CQUFXLEVBQUMsT0FBTyxDQUFDLHNCQUFZLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDdkUsT0FBTyxDQUFDLHNCQUFZLENBQUMsV0FBVyxDQUFDLEdBQUcsS0FBSyxDQUFDO0FBQ2xELENBQUM7QUFFRCxTQUFTLE1BQU0sQ0FBRSxLQUFjO0lBQzNCLElBQUksS0FBSyxLQUFLLElBQUk7UUFDZCxPQUFPLE1BQU0sQ0FBQztJQUVsQixJQUFJLEtBQUssSUFBSSxPQUFPLEtBQUssS0FBSyxRQUFRO1FBQ2xDLE9BQU8sS0FBSyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsV0FB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RUFBTyxPQUFPLENBQUMsS0FBSyxDQUFDLElBQUk7WUFDN0IsUUFBUSxFQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSTtZQUM3QixJQUFJLEVBQU8sT0FBTyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFO1lBQ3hDLFNBQVMsRUFBRSxPQUFPLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxRQUFRLElBQUksT0FBTyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQztTQUMzRyxDQUFDO1FBRUYsYUFBYSxDQUFDLFFBQVEsR0FBRyxHQUFHLENBQUMsUUFBUSxDQUFDO1FBQ3RDLGFBQWEsQ0FBQyxJQUFJLEdBQU8sR0FBRyxDQUFDLElBQUksQ0FBQztRQUNsQyxhQUFhLENBQUMsUUFBUSxHQUFHLEdBQUcsQ0FBQyxRQUFRLENBQUM7UUFDdEMsYUFBYSxDQUFDLElBQUksR0FBTyxHQUFHLENBQUMsSUFBSSxDQUFDO1FBQ2xDLGFBQWEsQ0FBQyxJQUFJLEdBQU8sbUJBQW1CLENBQUMsR0FBRyxDQUFDLFFBQVEsR0FBRyxHQUFHLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztLQUMzRjtJQUVELE9BQU8sSUFBSSxvQ0FBYyxDQUFDLGFBQWEsQ0FBQyxDQUFDO0FBQzdDLENBQUM7QUEzREQsb0RBMkRDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgT3V0Z29pbmdIdHRwSGVhZGVycyB9IGZyb20gJ2h0dHAnO1xuaW1wb3J0IHtcbiAgICBjYXN0QXJyYXksXG4gICAgaXNBcnJheUJ1ZmZlcixcbiAgICBpc0J1ZmZlcixcbiAgICBpc09iamVjdCxcbiAgICBpc1VuZGVmaW5lZCxcbn0gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBpc1N0cmVhbSBmcm9tICdpcy1zdHJlYW0nO1xuaW1wb3J0IHtcbiAgICBBdXRoT3B0aW9ucyxcbiAgICBDcmVkZW50aWFscyxcbiAgICBFeHRlcm5hbFJlcXVlc3RPcHRpb25zLFxuICAgIFBhcmFtcyxcbn0gZnJvbSAnLi9pbnRlcmZhY2VzJztcbmltcG9ydCB7XG4gICAgUmVxdWVzdE9wdGlvbnMsXG4gICAgcGFyc2VQcm94eVVybCxcbiAgICBSZXF1ZXN0T3B0aW9uc1BhcmFtcyxcbiAgICBzYW1lT3JpZ2luQ2hlY2ssXG59IGZyb20gJ3Rlc3RjYWZlLWhhbW1lcmhlYWQnO1xuaW1wb3J0IFRlc3RSdW4gZnJvbSAnLi4vaW5kZXgnO1xuaW1wb3J0IENPTlRFTlRfVFlQRVMgZnJvbSAnLi4vLi4vYXNzZXRzL2NvbnRlbnQtdHlwZXMnO1xuaW1wb3J0IEhUVFBfSEVBREVSUyBmcm9tICcuLi8uLi91dGlscy9odHRwLWhlYWRlcnMnO1xuaW1wb3J0IHsgUlVOVElNRV9FUlJPUlMgfSBmcm9tICcuLi8uLi9lcnJvcnMvdHlwZXMnO1xuaW1wb3J0IHsgQVBJRXJyb3IgfSBmcm9tICcuLi8uLi9lcnJvcnMvcnVudGltZSc7XG5pbXBvcnQgeyBHZXRQcm94eVVybENvbW1hbmQgfSBmcm9tICcuLi9jb21tYW5kcy9hY3Rpb25zJztcbmltcG9ydCB7IENhbGxzaXRlUmVjb3JkIH0gZnJvbSAnY2FsbHNpdGUtcmVjb3JkJztcblxuY29uc3QgREVGQVVMVF9BQ0NFUFQgICAgICAgICAgICA9IHsgW0hUVFBfSEVBREVSUy5hY2NlcHRdOiBgJHtDT05URU5UX1RZUEVTLmpzb259LCAke0NPTlRFTlRfVFlQRVMudGV4dFBsYWlufSwgJHtDT05URU5UX1RZUEVTLmFsbH1gIH07XG5jb25zdCBNRVRIT0RTX1dJVEhfQ09OVEVOVF9UWVBFID0gWydwb3N0JywgJ3B1dCcsICdwYXRjaCddO1xuY29uc3QgREVGQVVMVF9SRVFVRVNUX01FVEhPRCAgICA9ICdHRVQnO1xuY29uc3QgREVGQVVMVF9QUk9UT0NPTCAgICAgICAgICA9ICdodHRwOic7XG5cbmZ1bmN0aW9uIHNldENvbnRlbnRUeXBlSWZOb3RFeGlzdHMgKGhlYWRlcnM6IE91dGdvaW5nSHR0cEhlYWRlcnMsIHZhbHVlOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBpZiAoIWlzVW5kZWZpbmVkKGhlYWRlcnMpICYmIGlzVW5kZWZpbmVkKGhlYWRlcnNbSFRUUF9IRUFERVJTLmNvbnRlbnRUeXBlXSkpXG4gICAgICAgIGhlYWRlcnNbSFRUUF9IRUFERVJTLmNvbnRlbnRUeXBlXSA9IHZhbHVlO1xufVxuXG5mdW5jdGlvbiB0eXBlT2YgKHZhbHVlOiB1bmtub3duKTogc3RyaW5nIHtcbiAgICBpZiAodmFsdWUgPT09IG51bGwpXG4gICAgICAgIHJldHVybiAnbnVsbCc7XG5cbiAgICBpZiAodmFsdWUgJiYgdHlwZW9mIHZhbHVlID09PSAnb2JqZWN0JylcbiAgICAgICAgcmV0dXJuIHZhbHVlLmNvbnN0cnVjdG9yLm5hbWUudG9Mb3dlckNhc2UoKTtcblxuICAgIHJldHVybiB0eXBlb2YgdmFsdWU7XG59XG5cbmZ1bmN0aW9uIHRyYW5zZm9ybUJvZHkgKGhlYWRlcnM6IE91dGdvaW5nSHR0cEhlYWRlcnMsIGJvZHk/OiBhbnkpOiBCdWZmZXIge1xuICAgIGlmICghYm9keSlcbiAgICAgICAgcmV0dXJuIEJ1ZmZlci5mcm9tKCcnKTtcblxuICAgIGlmICh0eXBlT2YoYm9keSkgPT09ICdmb3JtZGF0YScgfHxcbiAgICAgICAgdHlwZU9mKGJvZHkpID09PSAnZmlsZScgfHxcbiAgICAgICAgdHlwZU9mKGJvZHkpID09PSAnYmxvYicgfHxcbiAgICAgICAgaXNBcnJheUJ1ZmZlcihib2R5KSB8fFxuICAgICAgICBpc0J1ZmZlcihib2R5KSB8fFxuICAgICAgICBpc1N0cmVhbShib2R5KVxuICAgIClcbiAgICAgICAgcmV0dXJuIEJ1ZmZlci5mcm9tKGJvZHkpO1xuICAgIGVsc2UgaWYgKEFycmF5QnVmZmVyLmlzVmlldyhib2R5KSlcbiAgICAgICAgcmV0dXJuIEJ1ZmZlci5mcm9tKGJvZHkuYnVmZmVyKTtcblxuICAgIGVsc2UgaWYgKGJvZHkgaW5zdGFuY2VvZiBVUkxTZWFyY2hQYXJhbXMpIHtcbiAgICAgICAgc2V0Q29udGVudFR5cGVJZk5vdEV4aXN0cyhoZWFkZXJzLCBgJHtDT05URU5UX1RZUEVTLnVybGVuY29kZWR9O2NoYXJzZXQ9dXRmLThgKTtcblxuICAgICAgICByZXR1cm4gQnVmZmVyLmZyb20oYm9keS50b1N0cmluZygpKTtcbiAgICB9XG4gICAgZWxzZSBpZiAoaXNPYmplY3QoYm9keSkgfHwgaGVhZGVycyAmJiBoZWFkZXJzW0hUVFBfSEVBREVSUy5jb250ZW50VHlwZV0gPT09IENPTlRFTlRfVFlQRVMuanNvbikge1xuICAgICAgICBzZXRDb250ZW50VHlwZUlmTm90RXhpc3RzKGhlYWRlcnMsIENPTlRFTlRfVFlQRVMuanNvbik7XG5cbiAgICAgICAgcmV0dXJuIEJ1ZmZlci5mcm9tKEpTT04uc3RyaW5naWZ5KGJvZHkpKTtcbiAgICB9XG4gICAgZWxzZSBpZiAodHlwZW9mIGJvZHkgPT09ICdzdHJpbmcnKVxuICAgICAgICBzZXRDb250ZW50VHlwZUlmTm90RXhpc3RzKGhlYWRlcnMsIENPTlRFTlRfVFlQRVMudGV4dFBsYWluKTtcblxuICAgIHJldHVybiBib2R5O1xufVxuXG5mdW5jdGlvbiBnZXRBdXRoU3RyaW5nIChhdXRoOiBBdXRoT3B0aW9ucyk6IHN0cmluZyB7XG4gICAgcmV0dXJuICdCYXNpYyAnICsgQnVmZmVyLmZyb20oYXV0aC51c2VybmFtZSArICc6JyArIGF1dGgucGFzc3dvcmQsICd1dGY4JykudG9TdHJpbmcoJ2Jhc2U2NCcpO1xufVxuXG5mdW5jdGlvbiBjaGFuZ2VIZWFkZXJOYW1lc1RvTG93ZXJjYXNlIChoZWFkZXJzOiBPdXRnb2luZ0h0dHBIZWFkZXJzKTogT3V0Z29pbmdIdHRwSGVhZGVycyB7XG4gICAgY29uc3QgbG93ZXJDYXNlSGVhZGVyczogT3V0Z29pbmdIdHRwSGVhZGVycyA9IHt9O1xuXG4gICAgT2JqZWN0LmtleXMoaGVhZGVycykuZm9yRWFjaChoZWFkZXJOYW1lID0+IHtcbiAgICAgICAgbG93ZXJDYXNlSGVhZGVyc1toZWFkZXJOYW1lLnRvTG93ZXJDYXNlKCldID0gaGVhZGVyc1toZWFkZXJOYW1lXTtcbiAgICB9KTtcblxuICAgIHJldHVybiBsb3dlckNhc2VIZWFkZXJzO1xufVxuXG5hc3luYyBmdW5jdGlvbiBwcmVwYXJlSGVhZGVycyAoaGVhZGVyczogT3V0Z29pbmdIdHRwSGVhZGVycywgY3VycmVudFBhZ2VVcmw6IFVSTCwgdXJsOiBVUkwsIGJvZHk6IEJ1ZmZlciwgdGVzdFJ1bjogVGVzdFJ1biwgd2l0aENyZWRlbnRpYWxzOiBib29sZWFuLCBvcHRpb25zOiBFeHRlcm5hbFJlcXVlc3RPcHRpb25zKTogUHJvbWlzZTxPdXRnb2luZ0h0dHBIZWFkZXJzPiB7XG4gICAgY29uc3QgeyBob3N0LCBvcmlnaW4gfSA9IHVybDtcblxuICAgIGNvbnN0IHByZXBhcmVkSGVhZGVyczogT3V0Z29pbmdIdHRwSGVhZGVycyA9IE9iamVjdC5hc3NpZ24oe30sIERFRkFVTFRfQUNDRVBULCBjaGFuZ2VIZWFkZXJOYW1lc1RvTG93ZXJjYXNlKGhlYWRlcnMpKTtcblxuICAgIHByZXBhcmVkSGVhZGVyc1tIVFRQX0hFQURFUlMuaG9zdF0gICAgICAgICAgPSBob3N0O1xuICAgIHByZXBhcmVkSGVhZGVyc1tIVFRQX0hFQURFUlMub3JpZ2luXSAgICAgICAgPSBvcmlnaW47XG4gICAgcHJlcGFyZWRIZWFkZXJzW0hUVFBfSEVBREVSUy5jb250ZW50TGVuZ3RoXSA9IGJvZHkubGVuZ3RoO1xuXG4gICAgaWYgKGhlYWRlcnMubWV0aG9kICYmIE1FVEhPRFNfV0lUSF9DT05URU5UX1RZUEUuaW5jbHVkZXMoU3RyaW5nKGhlYWRlcnMubWV0aG9kKSkpXG4gICAgICAgIHByZXBhcmVkSGVhZGVyc1tIVFRQX0hFQURFUlMuY29udGVudFR5cGVdID0gQ09OVEVOVF9UWVBFUy51cmxlbmNvZGVkO1xuXG4gICAgaWYgKG9wdGlvbnMuYXV0aCAmJiB3aXRoQ3JlZGVudGlhbHMpXG4gICAgICAgIHByZXBhcmVkSGVhZGVyc1tIVFRQX0hFQURFUlMuYXV0aG9yaXphdGlvbl0gPSBnZXRBdXRoU3RyaW5nKG9wdGlvbnMuYXV0aCk7XG5cbiAgICBpZiAob3B0aW9ucy5wcm94eT8uYXV0aClcbiAgICAgICAgcHJlcGFyZWRIZWFkZXJzW0hUVFBfSEVBREVSUy5wcm94eUF1dGhvcml6YXRpb25dID0gZ2V0QXV0aFN0cmluZyhvcHRpb25zLnByb3h5LmF1dGgpO1xuXG4gICAgaWYgKHdpdGhDcmVkZW50aWFscykge1xuICAgICAgICBjb25zdCBjdXJyZW50UGFnZUNvb2tpZXMgPSBhd2FpdCB0ZXN0UnVuLmNvb2tpZVByb3ZpZGVyLmdldENvb2tpZUhlYWRlcihjdXJyZW50UGFnZVVybC5ocmVmLCBjdXJyZW50UGFnZVVybC5ob3N0bmFtZSk7XG5cbiAgICAgICAgaWYgKGN1cnJlbnRQYWdlQ29va2llcylcbiAgICAgICAgICAgIHByZXBhcmVkSGVhZGVyc1tIVFRQX0hFQURFUlMuY29va2llXSA9IGN1cnJlbnRQYWdlQ29va2llcztcbiAgICB9XG5cbiAgICAvL05PVEU6IEFkZGl0aW9uYWwgaGVhZGVyIHRvIHJlY29nbml6ZSBBUEkgcmVxdWVzdHMgaW4gdGhlIGhhbW1lcmhlYWRcbiAgICBwcmVwYXJlZEhlYWRlcnNbSFRUUF9IRUFERVJTLmlzQXBpUmVxdWVzdF0gPSAndHJ1ZSc7XG5cbiAgICByZXR1cm4gcHJlcGFyZWRIZWFkZXJzO1xufVxuXG5hc3luYyBmdW5jdGlvbiBwcmVwYXJlVXJsICh0ZXN0UnVuOiBUZXN0UnVuLCBjdXJyZW50UGFnZVVybDogVVJMLCB1cmw6IHN0cmluZyB8IFVSTCwgY2FsbHNpdGU6IENhbGxzaXRlUmVjb3JkIHwgbnVsbCk6IFByb21pc2U8VVJMPiB7XG4gICAgbGV0IHByZXBhcmVkVXJsOiBVUkw7XG5cbiAgICB0cnkge1xuICAgICAgICBwcmVwYXJlZFVybCA9IHVybCBpbnN0YW5jZW9mIFVSTFxuICAgICAgICAgICAgPyB1cmxcbiAgICAgICAgICAgIDogbmV3IFVSTCh1cmwsIGN1cnJlbnRQYWdlVXJsLmhvc3RuYW1lID8gY3VycmVudFBhZ2VVcmwub3JpZ2luIDogdm9pZCAwKTtcbiAgICB9XG4gICAgY2F0Y2ggKGUpIHtcbiAgICAgICAgdGhyb3cgbmV3IEFQSUVycm9yKGNhbGxzaXRlLCBSVU5USU1FX0VSUk9SUy5yZXF1ZXN0VXJsSW52YWxpZFZhbHVlRXJyb3IsIHVybCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHByZXBhcmVkVXJsO1xufVxuXG5mdW5jdGlvbiBwcmVwYXJlU2VhcmNoUGFyYW1zICh1cmw6IHN0cmluZywgcGFyYW1zPzogUGFyYW1zKTogc3RyaW5nIHtcbiAgICBpZiAoIXBhcmFtcylcbiAgICAgICAgcmV0dXJuIHVybDtcblxuICAgIGxldCBzZWFyY2hQYXJhbXM6IFVSTFNlYXJjaFBhcmFtcztcblxuICAgIGlmIChwYXJhbXMgaW5zdGFuY2VvZiBVUkxTZWFyY2hQYXJhbXMpXG4gICAgICAgIHNlYXJjaFBhcmFtcyA9IHBhcmFtcztcbiAgICBlbHNlIHtcbiAgICAgICAgc2VhcmNoUGFyYW1zID0gbmV3IFVSTFNlYXJjaFBhcmFtcygpO1xuXG4gICAgICAgIGZvciAoY29uc3Qga2V5IGluIHBhcmFtcykge1xuICAgICAgICAgICAgaWYgKCFwYXJhbXNba2V5XSlcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcblxuICAgICAgICAgICAgY2FzdEFycmF5KHBhcmFtc1trZXldKS5mb3JFYWNoKHYgPT4ge1xuICAgICAgICAgICAgICAgIHNlYXJjaFBhcmFtcy5hcHBlbmQoa2V5LCB0eXBlb2YgdiA9PT0gJ29iamVjdCcgPyBKU09OLnN0cmluZ2lmeSh2KSA6IFN0cmluZyh2KSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBgJHt1cmx9JHt1cmwuaW5jbHVkZXMoJz8nKSA/ICcmJyA6ICc/J30ke3NlYXJjaFBhcmFtcy50b1N0cmluZygpfWA7XG59XG5cbmZ1bmN0aW9uIGdldFByb3h5VXJsICh0ZXN0UnVuOiBUZXN0UnVuLCB1cmw6IHN0cmluZywgd2l0aENyZWRlbnRpYWxzPzogYm9vbGVhbik6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgcmV0dXJuIHRlc3RSdW4uZXhlY3V0ZUNvbW1hbmQobmV3IEdldFByb3h5VXJsQ29tbWFuZCh7XG4gICAgICAgIHVybDogICAgIHVybCxcbiAgICAgICAgb3B0aW9uczogeyBjcmVkZW50aWFsczogd2l0aENyZWRlbnRpYWxzID8gQ3JlZGVudGlhbHMuaW5jbHVkZSA6IENyZWRlbnRpYWxzLm9taXQgfSxcbiAgICB9LCB0ZXN0UnVuLCB0cnVlKSkgYXMgUHJvbWlzZTxzdHJpbmc+O1xufVxuXG5hc3luYyBmdW5jdGlvbiByZXNvbHZlUG94eWxlc3NVcmxQYXJ0cyAodXJsOiBVUkwpOiBQcm9taXNlPHsgaG9zdG5hbWU6IHN0cmluZzsgcHJvdG9jb2w6IHN0cmluZzsgcG9ydDogc3RyaW5nOyBocmVmOiBzdHJpbmc7IHBhcnRBZnRlckhvc3Q6IHN0cmluZyB9PiB7XG4gICAgY29uc3Qge1xuICAgICAgICBocmVmLFxuICAgICAgICBob3N0bmFtZSxcbiAgICAgICAgcG9ydCxcbiAgICAgICAgcGF0aG5hbWUsXG4gICAgICAgIHNlYXJjaCxcbiAgICAgICAgcHJvdG9jb2wsXG4gICAgfSA9IHVybDtcblxuICAgIGNvbnN0IHBhcnRBZnRlckhvc3QgPSBbcGF0aG5hbWUsIHNlYXJjaF0uam9pbignJyk7XG5cbiAgICByZXR1cm4geyBwYXJ0QWZ0ZXJIb3N0LCBocmVmLCBob3N0bmFtZSwgcG9ydCwgcHJvdG9jb2wgfTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gcmVzb2x2ZVBveHlVcmxQYXJ0cyAodGVzdFJ1bjogVGVzdFJ1biwgdXJsOiBVUkwsIHdpdGhDcmVkZW50aWFsczogYm9vbGVhbik6IFByb21pc2U8eyBob3N0bmFtZTogc3RyaW5nOyBwcm90b2NvbDogc3RyaW5nOyBwb3J0OiBzdHJpbmc7IGhyZWY6IHN0cmluZzsgcGFydEFmdGVySG9zdDogc3RyaW5nIH0+IHtcbiAgICBjb25zdCBocmVmICAgICAgICAgICAgICAgPSBhd2FpdCBnZXRQcm94eVVybCh0ZXN0UnVuLCB1cmwuaHJlZiwgd2l0aENyZWRlbnRpYWxzKTtcbiAgICBjb25zdCB1cmxPYmogICAgICAgICAgICAgPSBhd2FpdCBwYXJzZVByb3h5VXJsKGhyZWYpO1xuICAgIGNvbnN0IHsgcGFydEFmdGVySG9zdCB9ICA9IHVybE9iajtcbiAgICBjb25zdCB7IGhvc3RuYW1lLCBwb3J0IH0gPSB1cmxPYmoucHJveHk7XG5cbiAgICByZXR1cm4geyBwYXJ0QWZ0ZXJIb3N0LCBocmVmLCBob3N0bmFtZSwgcG9ydCwgcHJvdG9jb2w6IERFRkFVTFRfUFJPVE9DT0wgfTtcbn1cblxuZnVuY3Rpb24gcmVzb2x2ZVVybFBhcnRzICh0ZXN0UnVuOiBUZXN0UnVuLCB1cmw6IFVSTCwgd2l0aENyZWRlbnRpYWxzOiBib29sZWFuKTogUHJvbWlzZTx7IGhvc3RuYW1lOiBzdHJpbmc7IHByb3RvY29sOiBzdHJpbmc7IHBvcnQ6IHN0cmluZzsgaHJlZjogc3RyaW5nOyBwYXJ0QWZ0ZXJIb3N0OiBzdHJpbmcgfT4ge1xuICAgIHJldHVybiB0ZXN0UnVuLmlzUHJveHlsZXNzKCkgPyByZXNvbHZlUG94eWxlc3NVcmxQYXJ0cyh1cmwpIDogcmVzb2x2ZVBveHlVcmxQYXJ0cyh0ZXN0UnVuLCB1cmwsIHdpdGhDcmVkZW50aWFscyk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjcmVhdGVSZXF1ZXN0T3B0aW9ucyAoY3VycmVudFBhZ2VVcmw6IFVSTCwgdGVzdFJ1bjogVGVzdFJ1biwgb3B0aW9uczogRXh0ZXJuYWxSZXF1ZXN0T3B0aW9ucywgY2FsbHNpdGU6IENhbGxzaXRlUmVjb3JkIHwgbnVsbCk6IFByb21pc2U8UmVxdWVzdE9wdGlvbnM+IHtcbiAgICBvcHRpb25zLmhlYWRlcnMgPSBvcHRpb25zLmhlYWRlcnMgfHwge307XG5cbiAgICBjb25zdCB1cmwgICAgICAgICAgICAgPSBhd2FpdCBwcmVwYXJlVXJsKHRlc3RSdW4sIGN1cnJlbnRQYWdlVXJsLCBvcHRpb25zLnVybCwgY2FsbHNpdGUpO1xuICAgIGNvbnN0IHdpdGhDcmVkZW50aWFscyA9ICFjdXJyZW50UGFnZVVybC5ob3N0IHx8IHNhbWVPcmlnaW5DaGVjayhjdXJyZW50UGFnZVVybC5ocmVmLCB1cmwuaHJlZikgfHwgb3B0aW9ucy53aXRoQ3JlZGVudGlhbHMgfHwgZmFsc2U7XG4gICAgY29uc3QgYm9keSAgICAgICAgICAgID0gdHJhbnNmb3JtQm9keShvcHRpb25zLmhlYWRlcnMsIG9wdGlvbnMuYm9keSk7XG4gICAgY29uc3QgaGVhZGVycyAgICAgICAgID0gYXdhaXQgcHJlcGFyZUhlYWRlcnMob3B0aW9ucy5oZWFkZXJzLCBjdXJyZW50UGFnZVVybCwgdXJsLCBib2R5LCB0ZXN0UnVuLCB3aXRoQ3JlZGVudGlhbHMsIG9wdGlvbnMpO1xuICAgIGxldCBhdXRoICAgICAgICAgICAgICA9IG9wdGlvbnMuYXV0aDtcblxuICAgIGNvbnN0IHtcbiAgICAgICAgaG9zdG5hbWUsXG4gICAgICAgIHBvcnQsXG4gICAgICAgIGhyZWYsXG4gICAgICAgIHBhcnRBZnRlckhvc3QsXG4gICAgICAgIHByb3RvY29sLFxuICAgIH0gPSBhd2FpdCByZXNvbHZlVXJsUGFydHModGVzdFJ1biwgdXJsLCB3aXRoQ3JlZGVudGlhbHMpO1xuXG4gICAgaWYgKCFhdXRoICYmIHVybC51c2VybmFtZSAmJiB1cmwucGFzc3dvcmQpIHtcbiAgICAgICAgYXV0aCA9IHtcbiAgICAgICAgICAgIHVzZXJuYW1lOiB1cmwudXNlcm5hbWUsXG4gICAgICAgICAgICBwYXNzd29yZDogdXJsLnBhc3N3b3JkLFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIGNvbnN0IHJlcXVlc3RQYXJhbXM6IFJlcXVlc3RPcHRpb25zUGFyYW1zID0ge1xuICAgICAgICBtZXRob2Q6ICAgICAgICAgb3B0aW9ucy5tZXRob2QgfHwgREVGQVVMVF9SRVFVRVNUX01FVEhPRCxcbiAgICAgICAgdXJsOiAgICAgICAgICAgIGhyZWYsXG4gICAgICAgIHByb3RvY29sOiAgICAgICBwcm90b2NvbCxcbiAgICAgICAgaG9zdG5hbWU6ICAgICAgIGhvc3RuYW1lLFxuICAgICAgICBob3N0OiAgICAgICAgICAgaG9zdG5hbWUsXG4gICAgICAgIHBvcnQ6ICAgICAgICAgICBwb3J0LFxuICAgICAgICBwYXRoOiAgICAgICAgICAgcHJlcGFyZVNlYXJjaFBhcmFtcyhwYXJ0QWZ0ZXJIb3N0LCBvcHRpb25zLnBhcmFtcyksXG4gICAgICAgIGF1dGg6ICAgICAgICAgICBhdXRoICYmIHdpdGhDcmVkZW50aWFscyA/IGAke2F1dGgudXNlcm5hbWV9OiR7YXV0aC5wYXNzd29yZH1gIDogdm9pZCAwLFxuICAgICAgICBoZWFkZXJzOiAgICAgICAgaGVhZGVycyxcbiAgICAgICAgY3JlZGVudGlhbHM6ICAgIHdpdGhDcmVkZW50aWFscyA/IHRlc3RSdW4uc2Vzc2lvbi5nZXRBdXRoQ3JlZGVudGlhbHMoKSA6IHZvaWQgMCxcbiAgICAgICAgYm9keTogICAgICAgICAgIGJvZHksXG4gICAgICAgIGRpc2FibGVIdHRwMjogICB0ZXN0UnVuLnNlc3Npb24uaXNIdHRwMkRpc2FibGVkKCksXG4gICAgICAgIHJlcXVlc3RUaW1lb3V0OiB7XG4gICAgICAgICAgICBhamF4OiBvcHRpb25zLnRpbWVvdXQsXG4gICAgICAgICAgICBwYWdlOiBvcHRpb25zLnRpbWVvdXQsXG4gICAgICAgIH0sXG4gICAgfTtcblxuICAgIGlmIChvcHRpb25zLnByb3h5KSB7XG4gICAgICAgIHJlcXVlc3RQYXJhbXMuZXh0ZXJuYWxQcm94eVNldHRpbmdzID0ge1xuICAgICAgICAgICAgaG9zdDogICAgICBvcHRpb25zLnByb3h5Lmhvc3QsXG4gICAgICAgICAgICBob3N0bmFtZTogIG9wdGlvbnMucHJveHkuaG9zdCxcbiAgICAgICAgICAgIHBvcnQ6ICAgICAgb3B0aW9ucy5wcm94eS5wb3J0LnRvU3RyaW5nKCksXG4gICAgICAgICAgICBwcm94eUF1dGg6IG9wdGlvbnMucHJveHkuYXV0aCA/IGAke29wdGlvbnMucHJveHkuYXV0aC51c2VybmFtZX06JHtvcHRpb25zLnByb3h5LmF1dGgucGFzc3dvcmR9YCA6IHZvaWQgMCxcbiAgICAgICAgfTtcblxuICAgICAgICByZXF1ZXN0UGFyYW1zLnByb3RvY29sID0gdXJsLnByb3RvY29sO1xuICAgICAgICByZXF1ZXN0UGFyYW1zLmhvc3QgICAgID0gdXJsLmhvc3Q7XG4gICAgICAgIHJlcXVlc3RQYXJhbXMuaG9zdG5hbWUgPSB1cmwuaG9zdG5hbWU7XG4gICAgICAgIHJlcXVlc3RQYXJhbXMucG9ydCAgICAgPSB1cmwucG9ydDtcbiAgICAgICAgcmVxdWVzdFBhcmFtcy5wYXRoICAgICA9IHByZXBhcmVTZWFyY2hQYXJhbXModXJsLnBhdGhuYW1lICsgdXJsLnNlYXJjaCwgb3B0aW9ucy5wYXJhbXMpO1xuICAgIH1cblxuICAgIHJldHVybiBuZXcgUmVxdWVzdE9wdGlvbnMocmVxdWVzdFBhcmFtcyk7XG59XG4iXX0=